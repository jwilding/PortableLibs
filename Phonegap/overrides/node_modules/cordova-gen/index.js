var Q = require('q');
var FS = require('fs');

var child = require('child_process');

var exec = Q.denodeify(child.exec);
var readFile = Q.denodeify(FS.readFile);

var parseString = require('xml2js').parseString;

// TODO icon is configable !

function convert(projectName,root,icon,screen,bg){
  if(!projectName){
    console.log('read projectName failed');
    return;
  }
  icon || (icon = 'res/icon.png');
  screen || (screen = 'res/screen.png');
  bg || (bg = "#000");

  var android = './res/android/';
  var ios = './res/ios/';

  if (!FS.existsSync("./res/")) FS.mkdirSync("./res/");

  if (!FS.existsSync(android)) FS.mkdirSync(android);
  if (!FS.existsSync(android + "icon/")) FS.mkdirSync(android + "icon/");
  if (!FS.existsSync(android + "screen/")) FS.mkdirSync(android + "screen/");

  if (!FS.existsSync(ios)) FS.mkdirSync(ios);
  if (!FS.existsSync(ios + "icon/")) FS.mkdirSync(ios + "icon/");
  if (!FS.existsSync(ios + "screen/")) FS.mkdirSync(ios + "screen/");

  var cmds = [
    'convert ' +icon+ ' -resize' + ' 128x128 ' + android + 'icon/icon.png',
    'convert ' +icon+ ' -resize' + ' 48x48 ' + android + 'icon/ldpi-icon.png',
    'convert ' +icon+ ' -resize' + ' 48x48 ' + android + 'icon/mdpi-icon.png',
    'convert ' +icon+ ' -resize' + ' 72x72 ' + android + 'icon/hdpi-icon.png',
    'convert ' +icon+ ' -resize' + ' 96x96 ' + android + 'icon/xhdpi-icon.png',
    'convert ' +icon+ ' -resize' + ' 144x144 ' + android + 'icon/xxhdpi-icon.png',
    // landing
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 1920x1920^> -extent 1920x1080  ' + android + 'screen/land-xxhdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 1280x1280^> -extent 1280x720  ' + android + 'screen/land-xhdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 800x800^> -extent 800x480  ' + android + 'screen/land-hdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 480x480^> -extent 480x320  ' + android + 'screen/land-mdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 320x320^> -extent 320x200  ' + android + 'screen/land-ldpi-screen.png',

    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 1920x1920^> -extent 1080x1920  ' + android + 'screen/port-xxhdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 1280x1280^> -extent 720x1280  ' + android + 'screen/port-xhdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 800x800^> -extent 480x800  ' + android + 'screen/port-hdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 480x480^> -extent 320x480  ' + android + 'screen/port-mdpi-screen.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 320x320^> -extent 200x320  ' + android + 'screen/port-ldpi-screen.png',


    'convert ' +icon+ ' -resize' + ' 57x57 ' + ios + 'icon/icon.png',
    //'convert ' +icon+ ' -resize' + ' 40x40 ' + ios + 'icon/icon-40.png',
    //'convert ' +icon+ ' -resize' + ' 50x50 ' + ios + 'icon/icon-50.png',
    'convert ' +icon+ ' -resize' + ' 57x57 ' + ios + 'icon/icon-57.png',
    //'convert ' +icon+ ' -resize' + ' 60x60 ' + ios + 'icon/icon-60.png',
    'convert ' +icon+ ' -resize' + ' 72x72 ' + ios + 'icon/icon-72.png',
    //'convert ' +icon+ ' -resize' + ' 76x76 ' + ios + 'icon/icon-76.png',
    //'convert ' +icon+ ' -resize' + ' 29x29 ' + ios + 'icon/icon-small.png',
    //'convert ' +icon+ ' -resize' + ' 512x512 ' + ios + 'icon/iTunesArtwork.png',
    //'convert ' +icon+ ' -resize' + ' 114x114 ' + ios + 'icon/icon-2x.png',
    //'convert ' +icon+ ' -resize' + ' 80x80 ' + ios + 'icon/icon-40-2x.png',
    //'convert ' +icon+ ' -resize' + ' 100x100 ' + ios + 'icon/icon-50-2x.png',
    'convert ' +icon+ ' -resize' + ' 114x114 ' + ios + 'icon/icon-57-2x.png',
    //'convert ' +icon+ ' -resize' + ' 120x120 ' + ios + 'icon/icon-60-2x.png',
    'convert ' +icon+ ' -resize' + ' 144x144 ' + ios + 'icon/icon-72-2x.png',
    //'convert ' +icon+ ' -resize' + ' 152x152 ' + ios + 'icon/icon-76-2x.png',
    //'convert ' +icon+ ' -resize' + ' 58x58 ' + ios + 'icon/icon-small-2x.png',
    //'convert ' +icon+ ' -resize' + ' 1024x1024 ' + ios + 'icon/iTunesArtwork-2x.png',

    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 480x480^> -extent 320x480  ' + ios + 'screen/screen-iphone.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 960x960^> -extent 640x960  ' + ios + 'screen/screen-iphone-2x.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 1136x1136^> -extent 640x1136  ' + ios + 'screen/screen-iphone-568h-2x.png',

    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 1024x1024^> -extent 768x1024  ' + ios + 'screen/screen-ipad-portrait.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 2048x2048^> -extent 1536x2048  ' + ios + 'screen/screen-ipad-portrait-2x.png',

    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 1024x1024^> -extent 1024x768  ' + ios + 'screen/screen-ipad-landscape.png',
    'convert ' +screen+ ' -background "'+bg+'" -gravity center -resize' + ' 2048x2048^> -extent 2048x1536  ' + ios + 'screen/screen-ipad-landscape-2x.png'
  ];

  function donext(){
    if(cmds.length){
      var cmd = cmds.pop();
      exec(cmd)
      .then(function(){
        console.log('[done]'+cmd);
        donext();
      })
      .fail(function(e){
        console.log('fail:'+cmd);
        console.log(e);
      })
    }else{
      console.log('done');
    }
  }
  donext();
}

function init(root,icon,screen,bg){
  // TODO read config.xml : 1. config.xml 2. www/config.xml
  readFile("./config.xml", "utf-8")
  .then(function (xml) {
    parseString(xml, function (err, result) {
      result && result.widget && result.widget.name && result.widget.name[0] && convert(result.widget.name[0],root,icon,screen,bg);
    });
  })
  .fail(function(e){
    console.log(e);
  })
}

module.exports = function(root,argv){
  argv = argv.slice(3);
  var icon = argv[0];
  var screen = argv[1];
  var bg = argv[2];
  // console.log(argv);
  init(root,icon,screen,bg);
}
